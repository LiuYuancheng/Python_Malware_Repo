# Python Deserialization Attack Introduction

### How to build a python pickle bomb

**Project design purpose** : This article will introduce an old and classic python data serialization feature and how red team attacker can use it as a vulnerability to build a malicious remote code/command execution attack bomb as a binary or text file when the other deserialized the data file. 



```
# Created:     2024/07/06
# Version:     v0.1.1
# Copyright:   Copyright (c) 2024 LiuYuancheng
# License:     MIT License
```

**Table of Contents**

[TOC]

------

### Introduction

Deserialization is the process of converting data from a serialized format back into its original data structure. A deserialization attack occurs when an application deserializes untrusted or maliciously crafted data, leading to potential security vulnerabilities. These attacks can result in various forms of exploitation, including arbitrary code execution, data corruption, and denial of service. The vulnerability arises because the deserialization process often assumes that the incoming data is well-formed and trustworthy. There are several Common Vulnerabilities and Exploits (CVEs) related the python Deserialization Vulnerabilities: 

1. **CVE-2011-3389**: Untrusted data passed to `pickle` deserialization can execute arbitrary code.
2. **CVE-2019-5021**: The `pickle` module in Python is vulnerable to arbitrary code execution due to unsafe deserialization.
3. **CVE-2018-1000802**: A deserialization vulnerability in the `pickle` module can be exploited to execute arbitrary code.
4. **CVE-2019-9636**: Insecure loading of a `pickle`-based format in the Pandas library can lead to arbitrary code execution.
5. **CVE-2019-20907**: Improper handling of serialized data leading to potential arbitrary code execution.



#### Introduction of Python Data Serialization

In Python, this often involves converting data from formats like JSON, YAML, XML and save to file for data storage and fetch. But if we want to save some complex data such as nest dictionary with bytes data or even build in object (as shown below):

```
# An data structure example which can not covert to Json Yaml or XML format.
from collections import OrderedDict
data = OrderedDict({
    'Timestamp': '2023-04-05 16:00:00',
    'IoTData': {
        'IP': '172.23.155.209',
        'Port': 3001,
        'value': [1.2, 1.3, 1.4],
        'RptPeer': {
            'Hub1': 1.2,
            'Hub2': 1.3
        },
        'CfgSet': set(['CT100', 'COM3', 3])  # set data is not support by json
    }
})
```

For the complex data object, json yaml or xml format will not work, it is very convenient to use the function pickle to convert the data to bytes so we can save them in file or transfer through network. We can use the pickle.dumps() to serialize the data to byets and pickle.loads() to deserialize the bytes to original data.  

But Python's `pickle` module is notorious for being insecure when used with untrusted data. If you go the the python `pickle`  official documents, it high lights  

![](img/introduction_00.png)

The `pickle` module can serialize and deserialize Python objects, but it has the capability to execute arbitrary code during deserialization. This feature can be exploited by attackers to run malicious code on the target system. A very simple way to build a pickle bomb is dumps a object with `__reduce__()` function:





