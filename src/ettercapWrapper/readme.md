# ARP Spoofing Attacker 

**Program design purpose** :  We want to create a ARP Spoofing Attacker which can be integrated in our C2 Emulation system to use the comprehensive suite software [Ettercap](https://www.ettercap-project.org/) to implement the ARP Spoofing attack to block/drop the specific packet send from / to the OT system HMI.  This program will be used for the [Cross Sword 2023 Cyber Exercise](https://www.linkedin.com/posts/natoccdcoe_crossedswords-activity-7140986334961217536-7dM5/?utm_source=share&utm_medium=member_desktop) test run Railway OT system attack demo.

**Attack Vector** : ARP Spoofing , traffic blocking

[TOC]

**Table of Contents**

- [ARP Spoofing Attacker](#arp-spoofing-attacker)
    + [Introduction](#introduction)
        * [OT-Attack Scenario Introduction](#ot-attack-scenario-introduction)
        * [ARP Spoofing Attack Observation](#arp-spoofing-attack-observation)
    + [Program Setup](#program-setup)
        
        * [Program File List](#program-file-list)
    + [Program Usage](#program-usage)
        * [Start APR Spoofing Packet Drop Attack from C2](#start-apr-spoofing-packet-drop-attack-from-c2)
        * [ARP spoofing attack (packet drop) demo video](#arp-spoofing-attack--packet-drop--demo-video)
      
      - [Problem and Solution](#problem-and-solution)

------

### Introduction 

This Ettercap wrapper ARP Spoofing malware is used to let the red team attacker can apply different kinds of packet filter on the network traffic via using Ettercap's ARP spoofing function on the router/switch to launch the packet drop, traffic block or even man in the middle attack. The ARP spoofing attacker is extended from the standard c2BackdoorTrojan module `<c2TestMalware>`by adding the our customized Ettercap Wrapper module, so the C2 Emulation system control it broad cast the ARP poisoning message to the railway HMI mode, the operational room subnet's switch/router and the related connected PLC sets.

Address Resolution Protocol (ARP) is a protocol that enables network communications to reach a specific device on the network. ARP translates Internet Protocol (IP) addresses to a Media [Access Control ](https://www.imperva.com/learn/application-security/broken-object-level-authorization-bola/)(MAC) address, and vice versa. Most commonly, devices use ARP to contact the router or gateway that enables them to connect to the Internet.

##### OT-Attack Scenario Introduction  

The ARP Spoofing attack demo will show the attacker uses one victim vm in the Operational Room subnet to do the ARP spoofing attack on Railway-SCADA-HMI by using the MiTM tool Ettercap. 

The attacker will apply a packets filter to the traffic between the Railway-SCADA-HMI and 2 PLCs(junction and station) to drop all the Modbus traffic packets to cut off the connection of railway state monitoring system. 

> Attack Pre-condition : In this demo, the attack program ettercapWrapper.py and Ettercap will be pre-installed by the previous IT-system-attack in one of the maintenance engineer's laptop which in the Train operation room subnet same as the HQ-Human Machine Interface (HMI) machine. 

The attack path in the cyber range is shown below : 

![](img/attackIntro1.png)

##### ARP Spoofing Attack Observation

Observation during the attack :

- When the attack happens, the Railway SCADA HMI PLC connection indicators will show total lose connection. 
- The railway HQ operator is able to detect the attack. But if he tries to use ping or other not Modbus(tcp-port 502) to test the network connection, he will not find any network problem.

The effect detail is shown below:

![](img/attackIntro2.png)

When the attack happens, the railway HQ operator may observe below situation :

- All the data on the railway-SCADA-HMI will not update. 

- The PLC connection indicators on railway-SCADA-HMI will show lose connection (change from green color to gray color). 

  

------

### Program Setup

To setup the false data injection program please refer to victim vm's ansible readme file: 

https://github.com/LiuYuancheng/Cross-Sword-2023-Nato-Event/blob/main/ansibleVM/railway-op-victim/Readme.md

Development/Execution Environment : python 3.7.4+

Additional Lib/Software Need : 

- Ettercap Installation : https://installati.one/install-ettercap-common-ubuntu-20-04/

##### Program File List

| Program File                    | Execution Env | Description                                    |
| ------------------------------- | ------------- | ---------------------------------------------- |
| ettercapWrapper.py              | python 3      | Main ARP spoof attacker packet droping program |
| ConfigLoader.py                 | python 3      | lib file : Configuration file loader           |
| c2Client.py                     | python 3      | lib file : C2 server communication file        |
| c2MwUtils.py                    | python 3      | lib file : malware data storage module         |
| ettercapWrapperCfg_template.txt |               | program config file                            |
| filter.json                     | json          | The Ettercap filter's config file.             |
| filters/*.ef                    | C++           | The Compiled Ettercap filters file             |



------

### Program Usage

To use the program, the host server need to pre-install the Ettercap tool : [Installation Link](https://installati.one/install-ettercap-common-ubuntu-20-04/) 

Set the config file base on your C2 server and attack target setting (rename the `ettercapWrapperCfg_template.txt` to `ettercapWrapperCfg.txt`) : 

```
# This is the config file template for the module <ettercapWrapper.py>
# Setup the paramter with below format (every line follows <key>:<val> format, the
# key can not be changed):

#-----------------------------------------------------------------------------
# Define the malware own info
OWN_ID:ettercapWrapper
# Change this line to 10.107.{{ team_nr }}07.5 during the event.
OWN_IP:192.168.50.10

#-----------------------------------------------------------------------------
# Init the C2 IP address
# Change this line to 10.106.{{ team_nr }}07.11 during the event.
C2_IP:127.0.0.1
C2_PORT:5000
# The interval to report to C2
C2_RPT_INV:5
# Init the C2 connection protocal
C2_HTTPS:False

#-----------------------------------------------------------------------------
# Init the filter folder and files.
FILTER_DIR:filters
FILTER_RCD:filter.json
```

Run the Ettercap Wrapper under **sudo**  (to apply the filter, Ettercap need to be run under admin permission), then the Ettercap Wrapper will link to C2 server:

```
sudo python3 ettercapWrapper.py
```

Check whether the Ettercap Wrapper registered on C2:

![](img/register.png)

##### Start APR Spoofing Packet Drop Attack from C2

Select the ettercapWrapper control page, then select the **Assign a special task via Json**, then fill in the task detail : 

- TaskType: `ettercapFilter`
- Repeat: `1`
- Tasks data: `packetDropper <filter name>`

```
# Tasks data str formate 1: <filetername> : use the default local filter json config.
# Tasks data str formate 2: <filetername>;<target ip>: use the user assigned config.
```

![](img/packetDrop.png)

Press the `submit` button, when the Ettercap wrapper report the task running,the Ettercap will applied the filter to keep block the traffic which incoming or outgoing the target. For the target information, please refer to the filter.json file, below is one dropper filter example, you can create your own filter and put in the filters folder and give a filter unique name in the filter.json file so you can apply it on the traffic:

```
"packetDropper" : {
    "ipaddress": "10.107.107.5",
    "protocalType": "TCP",
    "port":502,
    "description": "Drop all the packets from and to the IP address",
    "filterFile": "atk.ef"
}
```



##### ARP spoofing attack (packet drop) demo video

To check the demo video, please refer to this link in my you tube channel: https://www.youtube.com/watch?v=QmB0nJU1_q4



------

#### Problem and Solution

Refer to `doc/ProblemAndSolution.md`



------

> Last edit by LiuYuancheng(liu_yuan_cheng@hotmail.com) at 10/01/2024, if you have any problem, please send me a message.  Copyright (c) 2023 LiuYuancheng