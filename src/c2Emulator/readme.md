# Red Team C2 Hub Emulator

![](../../doc/img/c2Emulator/c2logo.png)

**Project Design Purpose** : Red Team Command and Control (C2) server, also known as a C&C server, is a centralized server or a set of servers that used by red team in cyber exercise / range to  control and communicate with compromised systems, often referred to as bots or zombies. The C2 server serves as the command center, allowing attackers to send instructions to the infected machines, receive data from them, and coordinate malicious activities. We want to provide a general C2 server emulation solution which allow cyber exercise red team members can hook different kind of Probing program / Malicious action program and dynamically monitor, schedule and control these program. It can by apply on below field : 

**Cyber Exercise Red Team Malicious C2 Servers Simulation **

- **Botnet Control:** Cybercriminals use C2 servers to control networks of compromised computers (botnets) for various malicious activities, such as launching DDoS attacks, stealing sensitive information, spreading malware, and more.
- **Remote Control:** C2 servers provide attackers with a means to remotely issue commands to compromised systems, allowing them to manipulate and control the infected machines.

**Defensive C2 Frameworks:**

- **Red Team Operations:** In the context of cybersecurity exercises, red teams (ethical hackers) may use C2 frameworks to simulate the tactics, techniques, and procedures (TTPs) of real-world adversaries. This helps organizations test their defenses and improve their incident response capabilities.
- **Training and Simulation:** Security professionals use C2 frameworks for training purposes, allowing them to understand and practice responding to simulated cyber threats in a controlled environment.

The RTC2 ( red team command and control ) system will provide a threading based client which user can easily hook the client into their malicious action program then integrate their program in the RTC2 system. The C2 server will also provide web interface and the http request handler API for the user to control the integrated malware via web-browser or their program. 

[TOC]

------

### Introduction 

Command and Control (C2) servers are not inherently necessary or beneficial for legitimate and ethical purposes. However, there are situations in the realm of cybersecurity where the concept of command and control is used for defensive purposes, typically in the context of security operations and incident response. In these cases, organizations might employ C2 frameworks or systems to simulate the behavior of real-world attackers. These simulations help security professionals and organizations assess their ability to detect, respond to, and mitigate cyber threats. We want to provide a general "plug and play" Red team C2 solution for: 

- **Cyber exercise red teaming** :  Used by red team to control the other DDoS Attacker, Data Theft program, phishing data generator.
- **Forensic traffic research** : used to simulate / repeat the attack scenario for C2 detection research and forensic analyze. 

The overview work flow of the RTC2 is shown below : 

![](../../doc/img/c2Emulator/overview.png)

`version v2.1`

The RTC2 system contents 2 part **Red Team C2 Hub Server** and **RTC2 Client** : 

**Red Team C2 Hub Server** : A web host program to control all the Malicious action program and handler the user's requirement. It will provide below function : 

-  User can user Web-UI to remote assigned different kinds of tasks to a specific Malicious action program such as run command on victim, upload file from victim machine, inject another program into victim or record the victim's user's action. 
- User can use the C2 Hub Server as a "bridge" to transfer file into or out from the victim machine to their local folder without doing the authorization on the victim. 
- User can use Web-dashboard to monitor the  Malicious action program execution state on the victim. 
- User's program can also use the web-API to do the automate control all Malicious action program linked to C2.

**RTC2 Client** : A multi-threading based client which user can hook it to their Malicious action program to communicate with the C2 Hub Server. 

- Running parallel with the Malicious action program's main thread to report the Malicious action program's state or tasks execution result to RTC2-Hub regularly. 
- Fetch the assigned tasks detail from the RTC2-Hub and call the related Malicious action program's function. 
- Handle the file / data translation requestion from RTC2-Hub.



------

### Program Design

We use the python-flask frame work to build our web-host and provided multi-threading API handling function for multiple users to use the service to control multiple Malicious action program at the same time. The system workflow is shown below : 

![](../../doc/img/c2Emulator/workflow.png)

`version v2.1`

#### RTC2 Web service API design 

The web service provide three kinds of HTTP/HTTPs API for different kinds of request. 

1. **User Web Control API** : This API will provide different kind of user-interface for user to assign tasks to malware, it will also provide several dashboard for red team user to monitor all the Malicious action program state or a specific Malicious action program's tasks execution details. 
2. **Program control API** : We also provide http-POST interface so the red team user can use their program to auto control all the functions provides by the Web Control API  to link their program with the RTC2
3. **Malware communication API** : This API is used to handle the communication from RTC2 client which hooked to the Malicious action program to fetch the data, assign the tasks or do the file tranfer. 

#### Malware Data manager Design 

The data manager is main "data base" to store all the information of a registered Malicious action program includes : unique malware ID, victim ip address, all the tasks details, every tasks' detail information (such as `taskID`, `taskType`, `StartTime`, `task repeat times`, `wait time before execution`, `task config parameters`, `task state and task result` ) . 

It will create the malwares state summary report when the red team member view the Malicious action program management web page. It will also read the malware's task summary report when the red team member browse the Malicious action program tasks page.

When the malicious action program register to the RTC2-Hub, it will also send all its re-config task information to the data manager. Below is a exmple of one task which is the Malicious action program will upload a zipped file to C2 server: 

```
{	
	'taskID': 1,
    'taskType': 'upload',
    'StartT': None,
    'repeat': 1,
    'ExPerT': 0,
    'taskData': [os.path.join(dirpath, "update_installer.zip")]
}
```

 

#### Malware Task Queue Manager 

The Malware Task Queue Manager is used by the RTC2 to synchronize the "tasks" with the related Malicious action program and handle the user's task adjust request. This will make sure the Malicious action program's task queue will be same as the RTC2's database. Below is a detail steps when use set a task to ask C2 to upload a file to C2. 

1. Red Team user set the upload file name from the web / program control API for  Malicious-action-program-1. 
2. The Task Queue Manager get the request and generate the file upload detail information and enqueue in Malicious-action-program-1's tasks queue. 
3. When the Malicious-action-program-1 report to the RTC2-Hub, the task queue manager will dequeue the file upload task and send the task information to the  Malicious-action-program-1. 
4. Malicious-action-program-1 will enqueue the file upload task to its own task queue. 
5. When the Malicious-action-program-1's next task execution function called, the program will upload the related file to the RTC2-hub. 
6. File uploaded and update the data manager's task record. 

For each task displayed on the tasks dashboard there will be five states : 

- **Task pending** : Task is enqueued in the RTC2-Hub task manager's sending queue. 
- **Task accepted** : Task information is sent to related Malicious-action-program. 
- **Task finished** : Task execution finished and state updated in the RTC2-Hub. 
- **Task deactivated** : Task is disabled in the  Malicious-action-program. 
- **Task Error** : Tasks execution error. 



------

### Program Setup



------

### Program Usage 

##### Upload file from red team user local to RTC2-Hub Storage  

**Via webpage : ** 

Main page => Malware management page [`http://127.0.0.1:5000/malwaremgmt`] => C2 File Storage Management => Upload a local file to C2 server : 

![](../../doc/img/c2Emulator/uploadfiletoC2.png)

Via http POST: 

```
http://<RTC2-Hub ip address >:<port>/fileupload, files={'file': (<filename>, fh.read())}
```



##### Download file from RTC2-Hub Storage to read team user local storage

**Via webpage : ** 

Main page => Malware management page [`http://127.0.0.1:5000/malwaremgmt`] => C2 File Storage Management => Download a file from C2 to local => select the file from dropdown menu => click the download button

![](../../doc/img/c2Emulator/downloadfiletolocal.png)

Via http GET: 

```
http://<RTC2-Hub ip address >:<port>/filedownload, json={"filename": filename}
```



##### Assign command execution task to Malicious-action-program

**Via webpage : ** 

Malware management page => related task detail dashboard link => Run Commands On Target =>Input the command string => click submit button to assign the task to the  Malicious-action-program

![](../../doc/img/c2Emulator/runcmd.png)

Then the task finished the command execution result will be shown in the Last report log area. 

**Via http POST:** 

```
http://<RTC2-Hub ip address >:<port>/addcommand, json={"malwareID": <ID>, "commandData": <commandstr> }
```

