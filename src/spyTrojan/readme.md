# SpyTrojan Emulator

**Program design purpose :** We want to create a spy trojan emulation program wich can be integreated in our C2 Emulation system, so one/multiple red team hackres can remote monitor user's action (logging keyboard event, take screen shot) and do same malicious action (run commands, inject other malware, scan the network, ssh to other victim) on multiple victim host. This program will be used for the Lock Shield 2024 Cyber Exercise DFIR(digital forensics and incident response) section.

[TOC]

------

### Introduction 

This Spy Trojan is inherted from the [C2 Emulation system](https://github.com/LiuYuancheng/Python_Malwares_Repo/tree/main/src/c2Emulator) standard backdoor trojan example `<backdoorTrojan.py>` and added the below special function:

- Keyboard event logging and user keyboard type in simulation from User Emulator Project `keyEventActor.py`  [source code](https://github.com/LiuYuancheng/Windows_User_Simulator/blob/main/src/actionScheduler/UtilsFunc/keyEventActors.py)
- Network Scanning function from User Emulator Project lib `nmapUtils.py` [source code](https://github.com/LiuYuancheng/Windows_User_Simulator/blob/main/src/lib/nmapUtils.py)
- SSH login and run cmd and SCP file copy from SSHconnecor lib [project link](https://github.com/LiuYuancheng/SSH-connector)
- User desktop screen shot function. 

The red team hacker will use the User Emulator Profile to simulate one/multiple hackers give different intruction to 4 malware which running in 4 victim to do different malicious action at different time. All the action are driven by the hacker's profile.

User emulation project : [Github Repo link](https://github.com/LiuYuancheng/Windows_User_Simulator)

The whole system work flow is shown below:

![](img/LS24Overview.png)

`version v0.2.2`

#### Background knowledge

Different between backdoor Trojan and Spy Trojan: 

Backdoor Trojans and Spy Trojans are both types of Trojan horses, which are malicious software that disguises itself as legitimate or benign to deceive users into executing them. However, they serve different purposes and have distinct functionalities:

##### Backdoor Trojan

- **Functionality:** A Backdoor Trojan, as the name suggests, creates a secret entry point (backdoor) into the infected system, allowing unauthorized access and control.
- **Objective:** The primary goal of a Backdoor Trojan is to provide remote access to the attacker, enabling them to perform various malicious activities without the user's knowledge.
- **Capabilities**:
  - Opening a network port for communication.
  - Uploading and downloading files.
  - Executing commands remotely.
  - Installing additional malware.
- **Risk:** Backdoor Trojans pose a significant security risk as they can give attackers persistent access to the compromised system, leading to data theft, system manipulation, or further exploitation.

##### Spy Trojan

- **Functionality:** A Spy Trojan is designed to monitor and collect sensitive information from the infected system without the user's awareness.
- **Objective:** The primary goal of a Spy Trojan is to steal valuable data, such as login credentials, personal information, financial details, or other sensitive data.
- Capabilities:
  - Keylogging: Recording keystrokes to capture passwords and other text input.
  - Screen capture: Taking screenshots to capture sensitive information displayed on the screen.
  - Clipboard capture: Collecting data copied to the clipboard.
  - Webcam or microphone surveillance: Monitoring audio and video inputs.
- **Risk:** Spy Trojans are a significant privacy and security threat as they can lead to identity theft, unauthorized access to accounts, or the compromise of confidential information.



------

### Program Setup

Development/Execution Environment : python 3.7.4+

Additional Lib/Software Need : 

- keyboard 0.13.5 : https://pypi.org/project/keyboard/
- pyscreenshot 3.1 : https://pypi.org/project/pyscreenshot/



------

### Program Usage 

Set the config file base on your RTC2 server (rename the `spyTrojanCfg_template.txt` to `spyTrojanCfg.txt` ): 

Run the spy trojan to connect to the RTC2 server: 

```
python falsecmdinjector.py
```

Check whether the false data injector registered on C2:

##### 1.Run command on victim machine 

Refer to RTC2 Emulation system document section [Assign Command Execution Task to Malicious-Action-Program](https://github.com/LiuYuancheng/Python_Malwares_Repo/blob/main/src/c2Emulator/readme.md)



##### 2.Steal a cretical file from victim machine

Refer to RTC2 Emulation Sysetm document section [Copy File From the Victim Machine to RTC2-Hub](https://github.com/LiuYuancheng/Python_Malwares_Repo/blob/main/src/c2Emulator/readme.md)



##### 3.Inject another malware/file to the victim machine 

Refer to RTC2 Emulation Sysetm document section [Inject file from C2 to target victim machine ](https://github.com/LiuYuancheng/Python_Malwares_Repo/blob/main/src/c2Emulator/readme.md)



##### 4.Scan the victim subnet to find all the host IP addresses

Select the related spytrojan(we use spytrojan01 as example) page, then select the **Assign a special task via Json**, then fill in the task detail : 

- TaskType: `scanSubnet`
- Repeat: `int <number of the injection repeat times>`
- Tasks data: `<subnet string> example:172.25.121.0/24 `

Assign task from Web-UI

![](img/func4_scanSubnet.png)

After the task executed (state change to finsih) , click the show task result to list all the IP addresses in the subnet 

- **Via HTTP POST request** : 

```
http://<RTC2-Hub ip address >:<port>/addnewtask, json={"malwareID": <ID>, "taskType": "scanSubnet", "taskdata": <task detail infomration json data> }

Example: 
requests.get(http://127.0.0.1:5000/addnewtask, json={"malwareID':"spyTrojan01","taskType":"scanSubnet","taskdata":"172.25.121.0/24" })
```



##### 5.Logging User Keyboard Input for time interval

Select the related spytrojan(we use spytrojan01 as example) page, then select the **Assign a special task via Json**, then fill in the task detail : 

- TaskType: `keyEvent`
- Repeat: `1`
- Tasks data: `startRcd;<record time interval in Sec> example:startRcd;10 ` if the interval < 0, spytrojan will keep logging  untill received the keyboard logging stop task. 

Assign task from Web-UI

![](img/startRcd.png)

- **Via HTTP POST request** : 

```
http://<RTC2-Hub ip address >:<port>/addnewtask, json={"malwareID": <ID>, "taskType": "keyEvent", "taskdata": <task detail infomration json data> }

Example: 
requests.get(http://127.0.0.1:5000/addnewtask, json={"malwareID':"keyEvent","taskType":"keyEvent","taskdata":"startRcd;10" })
```

The key logging function is running parallel with the main thread, red team hacker can assign other task during the logging.



##### 6.Get the Keyboard Logging data (simple string)

Select the related spytrojan (we use spytrojan01 as example) page, then select the **Assign a special task via Json**, then fill in the task detail : 

- TaskType: `keyEvent`
- Repeat: `1`
- Tasks data: `getEven;simple`

Assign task from Web-UI

![](img/getkeySimple.png)

After the task finished, click the show task result to check the logged keyboard string in the last record period.

- **Via HTTP POST request** : 

```
http://<RTC2-Hub ip address >:<port>/addnewtask, json={"malwareID": <ID>, "taskType": "keyEvent", "taskdata": "getEven;Simple" }

Example: 
requests.get(http://127.0.0.1:5000/addnewtask, json={"malwareID':"keyEvent","taskType":"keyEvent","taskdata":"getEvent;simple" })
```



##### 7.Get the Keyboard Logging data (Detailed keyboard event)

If you want to check the keyboard key press time, release time, combined keys and all the detail, select the related spytrojan (we use spytrojan01 as example) page, then select the **Assign a special task via Json**, then fill in the task detail 

- TaskType: `keyEvent`
- Repeat: `1`
- Tasks data: `getEven;detail`

Assign task from Web-UI

![](img/getkeyDetail.png)

After the task finished, click the show task result to check the logged keyboard action details in the last record period.

- **Via HTTP POST request** : 

```
http://<RTC2-Hub ip address >:<port>/addnewtask, json={"malwareID": <ID>, "taskType": "keyEvent", "taskdata": "getEven;detail" }

Example: 
requests.get(http://127.0.0.1:5000/addnewtask, json={"malwareID':"keyEvent","taskType":"keyEvent","taskdata":"getEvent;detail" })
```



##### 8.Stop Current Key Logging (save in file)

To force stop a running keylogging, Select the related spytrojan(we use spytrojan01 as example) page, then select the **Assign a special task via Json**, then fill in the task detail : 

- TaskType: `keyEvent`
- Repeat: `1`
- Tasks data: `stopRcd;None` (Just stop the keyboard logging). 

Assign task from Web-UI

![](img/stopRcd.png)

Stop and save the keyboard log in a file in the victim local folder.

Tasks data: `stopRcd;<filename> example:stopRcd;keyrecord.log `

Assign task from Web-UI:

![](img/keylog.png)

After the task finished, a keyboard event record file will be created in the victim's local folder, hacker can also use the file upload API to transfer it from victim to RTC2 hub, the record will be json format as shown below :

![](img/keylogfile.png)

- **Via HTTP POST request** : 

```
http://<RTC2-Hub ip address >:<port>/addnewtask, json={"malwareID": <ID>, "taskType": "keyEvent", "taskdata": "stopRcd;<paramter>" }

Example: 
requests.get(http://127.0.0.1:5000/addnewtask, json={"malwareID':"keyEvent","taskType":"keyEvent","taskdata":"stopRcd;keyrecord.log" })
```



##### 9.Simualte user type in data via keyboard

If you want to simulate usr type in data via keyboard, Select the related spytrojan(we use spytrojan01 as example) page, then select the **Assign a special task via Json**, then fill in the task detail : 

- TaskType: `keyEvent`
- Repeat: `1`
- Tasks data: `typeInStr;<inputString>` 

Assign task from Web-UI (Assume we want to type in helloworld! ) :

![](img/typeIn.png)



When the task shows "running", if you click any text field, you can see the string will be type in

![](img/typeIn2.png)

- **Via HTTP POST request** : 

```
http://<RTC2-Hub ip address >:<port>/addnewtask, json={"malwareID": <ID>, "taskType": "keyEvent", "taskdata": "typeInStr;<inputString>" }

Example: 
requests.get(http://127.0.0.1:5000/addnewtask, json={"malwareID':"keyEvent","taskType":"keyEvent","taskdata":"typeInStr;helloworld!" })
```



##### 10.Screen shot current disktop and upload to RTC2

If you want to screen shot the current user's desktop, Select the related spytrojan(we use spytrojan01 as example) page, then select the **Assign a special task via Json**, then fill in the task detail : 

- TaskType: `screenShot`
- Repeat: `1`
- Tasks data: `None or image file name` 

Assign task from Web-UI : 

![](img/screenShotAutoName.png)



If the victim is a Desktop version OS and can do the screen capture, the result will show the file name and upload state:

![](img/screenShot2.png)

Go to the management page to download the screen shot file:

![](img/screenShot3.png)

- **Via HTTP POST request** : 

```
http://<RTC2-Hub ip address >:<port>/addnewtask, json={"malwareID": <ID>, "taskType": "screenShot", "taskdata": "None" }

Example: 
requests.get(http://127.0.0.1:5000/addnewtask, json={"malwareID':"keyEvent","taskType":"screenShot","taskdata":"None" })
```



##### 11.SSH login a host (or multi host ssh tunnel) , run cmd and get reuslt 

- [ ] When Rose learned how to use lib [SSHconnector.py](https://github.com/LiuYuancheng/SSH-connector/blob/main/src/SSHconnector.py), assigne this task to her.



##### 12.SSH login a host (or multi host ssh tunnel) , scp the file

- [ ] When Rose learned how to use lib [SCPconnector.py](https://github.com/LiuYuancheng/SSH-connector/blob/main/src/SCPconnector.py), assigne this task to her.



##### 13.SSH login a host (or multi host ssh tunnel)  , fowared a website in the subnet to victim

- [ ] When Rose learned how to use lib [SSHforwarder.py](https://github.com/LiuYuancheng/SSH-connector/blob/main/src/SSHforwarder.py), assigne this task to her.





------

>  Last edit by LiuYuancheng (liu_yuan_cheng@hotmail.com) at 16/01/2024, if you have any problem please free to message me.